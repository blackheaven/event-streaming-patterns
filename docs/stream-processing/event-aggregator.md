# Event Aggregator

In some scenarios individual events need to be combined into a single encompassing event, for example when events generated by the [Event Splitter](../event-processing/event-splitter.md) have been processed and need to be re-aggregated.

## Problem

How can we collect individual but related events and, when we have them all, include them in a new event?

## Solution Pattern
![event-aggregator](../img/event-aggregator.png)

We can build an aggregator application in which we will use a unique value in the event, perhaps a [Correlation Identifer](../docs/event/correlation-identifier.md) to find related events and add them to an aggregate if one exists.  If no aggregate exists, we create one and add the event. Then we check a completion condition and if true, we will produce a new event with that aggregate. The completion condition will vary by use case, but in our example it will be an expected total included in each event.

## Example Implementation
```
final Map<String ProcessedOrder> orders = new HashMap<>();

while (keepConsuming) {
  try {
    final ConsumerRecords<String, ProcessedItem> records = consumer.poll(Duration.ofSeconds(1));
    records.forEach(record -> {
      ProcessedOrder order = orders.get(record.key());
      if(order == null){
        order = new ProcessedOrder();
        orders.put(record.key(), order);
      }
      order.addItem(record.value());
      if (record.value().getTotal().equals(order.itemCount())){
        produceProcessedOrderEvent(order);
      }
    }
  }
  catch (Exception ex) {
    ...
  }
}
```

## Considerations
We may not always have such a clear-cut completion condition. In some situations we may want to include a timeout and a way to deal with an incomplete aggregate. We may also need to keep completed aggregates for some period of time, in order to prevent creation of duplicates. 

## References
This pattern was derived from [Aggregator](https://www.enterpriseintegrationpatterns.com/patterns/messaging/Aggregator.html) pattern in Enterprise Integration Patterns by Gregor Hohpe and Bobby Woolf

